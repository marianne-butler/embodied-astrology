<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="images/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Visual Tools for Astrologers"
    />
    <title>Embodied Astrology</title>
    <link rel="stylesheet" href="css/stytch.css" />
  </head>
  <body>
    <noscript>Embodied Astrology requires JavaScript to run.</noscript>
    <main>
      <h1 id="status">Welcome</h1>
      <button onclick="magic('marianne.voidofcourse@gmail.com')">GET MAGIC LINK</button>
      <button onclick="profile()">SHOW PROFILE</button>
    </main>
  </body>
  <script>
    let user_id, 
    email = "marianne.voidofcourse@gmail.com";

    const status = document.querySelector('#status'),
    main = querySelector("main"),
    params = new URLSearchParams(window.location.search),
    token = params.get("token"),
    stytch_token_type = params.get("stytch_token_type");


    async function magic() {
      try {
            fetch(`https://embodied-astrology.netlify.app/.netlify/functions/api?action=MAGIC&email=${email}`)
              .then((res) => res.json()
                .then((result) => {
                  setStatus("EMAIL", result);
                }));
        } catch(err) {
          setStatus("ERROR", err);
        }
    }

    async function astrology() {
      fetch(`https://embodied-astrology.netlify.app/.netlify/functions/api?action=CHART&user_id=${user_id}`)
      .then((res) => res.json().then(handleresponse));
    }

    function handleresponse(resp) {
      const {user, error_type} = resp;

      if (error_type != null) setStatus("MAGIC", {error: error_type});
      else {
        user_id = user.user_id;

        const {natal} = user.trusted_metadata;
        if (natal == null) {
          setStatus("ASTROLOGY", user);
          astrology();
        }
        else setStatus("PROFILE", user);
      }
    }

    function setStatus(status, data) {
      console.log("status", data);
      main.setAttribute("data-status", status);

      switch(status) {
        case "AUTH":
            status.innerText = "Authenticating";
            break;

        case "MAGIC":
            status.innerText = "Enter your email address to login or signup";
            break;
        
        case "EMAIL":
          status.innerText = "We've sent a magic link to the email address you provided";
          break;

        case "ERROR":
          status.innerText = "Something went wrong";
          break;

        case "ASTROLOGY":
          const {first_name} = data.name;
          status.innerText = `Hi ${first_name}, we're getting your chart`;
          break;

        case "PROFILE":
          const {first_name} = data.name;
          status.innerText = `Hi ${first_name}, here's your chart!`;
          break;

        default: 
          status.innerText = status;
          break;
      }
    }

    setStatus("AUTH");

    if (token == null || stytch_token_type == null) {
        fetch(`https://embodied-astrology.netlify.app/.netlify/functions/api?action=AUTH`)
        .then((res) => res.json().then(handleresponse));
    }
    else {
      fetch(`https://embodied-astrology.netlify.app/.netlify/functions/api?action=LOGIN&token=${token}&stytch_token_type=${stytch_token_type}`)
      .then((res) => res.json().then(handleresponse));
    }
  </script>
</html>