<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="images/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="An example JavaScript application using Stytch for authentication"
    />
    <title>Stytch JavaScript Example</title>
    <link rel="stylesheet" href="css/stytch.css" />
  </head>
  <body>
    <noscript>
      The Stytch JavaScript example application requires JavaScript to run.
    </noscript>
    <main>
      <h1 id="status">Welcome</h1>
      <button onclick="get('action=PROFILE')">PROFILE</button>
      <button onclick="get('action=SESSION')">SESSIONS</button>
      <button onclick="astrology()">ASTROLOGY</button>
      <button onclick="login('marianne.voidofcourse@gmail.com')">GET MAGIC LINK</button>
      <button onclick="save(true)">SAVE COOKIE</button>
      <button onclick="save(false)">DONT SAVE COOKIE</button>
    </main>
  </body>
  <script>
    let user_id;

    const status = document.querySelector('#status'),
    params = new URLSearchParams(window.location.search),
    token = params.get("token"),
    stytch_token_type = params.get("stytch_token_type");

    async function save(save) {
       setStatus(`Show Profile (cookie=${save ? "yes" : "no"})`);
    }

    async function login(email) {
      try {
            fetch(`https://embodied-astrology.netlify.app/.netlify/functions/playground?action=MAGIC&email=${email}`)
              .then((res) => res.json()
                .then((result) => {
                  setStatus("Check your email!")
                  console.log(result);
                }));
        } catch(err) {
          console.log(err);
          setStatus("Something's not right")
        }
    }

    async function get(params) {
      try {
          fetch(`https://embodied-astrology.netlify.app/.netlify/functions/playground?user_id=${user_id}&${params}`)
            .then((res) => res.json()
              .then((result) => console.log(result)));
      } catch(err) {
        console.log(err);
      }
    }

    function handleUserDataResponse(resp) {
      const {user, session_jwt, error_type} = resp;
      console.log(resp);

      if (error_type != null) setStatus(`${error_type} : Request Magic Link`);
      else {
        user_id = user.user_id;
        const {natal} = user.trusted_metadata;
        const {first_name} = user.name;
        if (natal == null) setStatus("Get natal snapshot");
        else {
          console.log(natal);
          setStatus(`Hi ${first_name}! Save Cookie?`);
        }
        // console.log(session_jwt);
      }
    }

    async function astrology() {
      setStatus("Getting natal chart");

      fetch(`https://embodied-astrology.netlify.app/.netlify/functions/playground?action=CHART&user_id=${user_id}`)
      .then((res) => res.json().then(handleUserDataResponse));
    }

    function setStatus(string) {
      status.innerText = string;
    }

    if (token == null || stytch_token_type == null) {
      // first look for cookie
      setStatus("Request Magic Link");
    }
    else {
      setStatus("Authenticating");

      fetch(`https://embodied-astrology.netlify.app/.netlify/functions/playground?action=LOGIN&token=${token}&stytch_token_type=${stytch_token_type}`)
      .then((res) => res.json().then(handleUserDataResponse));
    }
  </script>
</html>