<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="images/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="An example JavaScript application using Stytch for authentication"
    />
    <title>Stytch JavaScript Example</title>
    <link rel="stylesheet" href="css/stytch.css" />
  </head>
  <body>
    <noscript>
      The Stytch JavaScript example application requires JavaScript to run.
    </noscript>
    <main>
      <h1 id="status">Welcome</h1>
      <!-- <button onclick="get('action=PROFILE&user_id=user-test-8017ffda-19a0-44ef-92fe-d445c9b0d0a6')">PROFILE</button> -->
      <!-- <button onclick="get('action=SESSIONS&user_id=user-test-8017ffda-19a0-44ef-92fe-d445c9b0d0a6')">SESSIONS</button> -->
      <button onclick="login('marianne.voidofcourse@gmail.com')">GET MAGIC LINK</button>
      <button onclick="cookie(true)">SAVE COOKIE</button>
      <button onclick="cookie(false)">DONT SAVE COOKIE</button>
    </main>
  </body>
  <script>
    const status = document.querySelector('#status'),
    params = new URLSearchParams(window.location.search),
    token = params.get("token"),
    stytch_token_type = params.get("stytch_token_type");

    async function cookie(save) {
       setStatus(`Show Profile (cookie=${save ? "yes" : "no"})`);
    }

    async function login(email) {
      try {
            fetch(`https://embodied-astrology.netlify.app/.netlify/functions/playground?action=MAGIC&email=${email}`)
              .then((res) => res.json()
                .then((result) => {
                  setStatus("Check your email!")
                  console.log(result);
                }));
        } catch(err) {
          console.log(err);
          setStatus("Something's not right")
        }
    }

    async function get(params) {
        try {
            fetch(`https://embodied-astrology.netlify.app/.netlify/functions/playground?${params}`)
              .then((res) => res.json()
                .then((result) => console.log(result)));
        } catch(err) {
          console.log(err);
        }
    }

    function setStatus(string) {
       status.innerText = string;
    }

    if (token == null || stytch_token_type == null) {
      // first look for cookie
      setStatus("Request Magic Link");
    }
    else {
      setStatus("Authenticating");

      fetch(`https://embodied-astrology.netlify.app/.netlify/functions/playground?action=LOGIN&token=${token}&stytch_token_type=${stytch_token_type}`)
        .then((res) => {
          res.json()
            .then(({user, session_jwt}) => {
              console.log(user);
              console.log(session_jwt);
              // do you want to store a cookie?
              setStatus("Save Cookie?");
            });
        })
        .catch((err) => setStatus(`${err.error_type} : Request Magic Link`));
    }
  </script>
</html>