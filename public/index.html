<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="images/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Visual Tools for Astrologers"
    />
    <title>Embodied Astrology</title>
    <link rel="stylesheet" href="css/ea.css" />
  </head>
  <body>
    <noscript>Embodied Astrology requires JavaScript to run.</noscript>
    <header>
      <h1>EMBODIED ASTROLOGY</h1>
      <h2>Welcome</h2>
    </header>
    <main></main>
  </body>
  <script>
    let user_id, email, chart;

    const message = document.querySelector('h2'),
    main = document.querySelector("main"),
    params = new URLSearchParams(window.location.search),
    token = params.get("token"),
    stytch_token_type = params.get("stytch_token_type");

    function validateEmail(value) {
      return (value.match(/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/));
    }

    main.addEventListener("click", (e) => {
      switch(e.target.getAttribute("data-action")) {
        case "MAGIC":
          email = document.querySelector('input[data-id="EMAIL"]').value;
          setStatus(validateEmail(email) ? "LOADING" : "INVALID_EMAIL");
          break;

          default:
          break;
        }
    });


    async function magic() {
      try {
            fetch(`https://embodied-astrology.netlify.app/.netlify/functions/api?action=MAGIC&email=${email}`)
              .then((res) => res.json()
                .then((result) => {
                  setStatus("EMAIL", result);
                }));
        } catch(err) {
          setStatus("ERROR", err);
        }
    }

    async function astrology() {
      fetch(`https://embodied-astrology.netlify.app/.netlify/functions/api?action=CHART&user_id=${user_id}`)
      .then((res) => res.json().then(handleresponse));
    }

    function handleresponse(resp) {
      const {user, error_type} = resp;

      if (error_type != null) setStatus("MAGIC", {error: error_type});
      else {
        user_id = user.user_id;

        const {natal} = user.trusted_metadata;
        if (natal == null) {
          setStatus("ASTROLOGY", user);
          astrology();
        }
        else setStatus("PROFILE", user);
      }
    }

    function setStatus(status, data = {}) {
      console.log("status", status, data);
      const {name, error_type} = data;
      main.setAttribute("data-status", status);

      switch(status) {
        case "AUTH":
            message.innerText = "Authenticating";
            break;

        case "MAGIC":
            message.innerText = "Welcome!";
            main.innerHTML = `
              <label>
                <span>Enter your email address to login or signup</span>
                <input data-id="EMAIL" type="email" placeholder="email address" />
                <button data-action="MAGIC">SUBMIT</button>
                <small></small>
              </label>
            `;
            break;
        
        case "INVALID_EMAIL":
           main.querySelector('small').innerText = "Please enter a valid email address :)";
           break;

         case "LOADING":
            main.innerHTML = "Loading...";
            break;

        case "EMAIL":
          message.innerText = `We've sent a magic link to ${email}`;
          break;

        case "ERROR":
          message.innerText = "Something went wrong";
          break;

        case "ASTROLOGY":
          message.innerText = `Hi ${name.first_name}, we're getting your chart`;
          break;

        case "PROFILE":
          message.innerText = `Hi ${name.first_name}, here's your chart!`;
          break;

        default: 
          message.innerText = status;
          break;
      }
    }

    setStatus("AUTH");

    if (token == null || stytch_token_type == null) {
        fetch(`https://embodied-astrology.netlify.app/.netlify/functions/api?action=AUTH`)
        .then((res) => res.json().then(handleresponse));
    }
    else {
      fetch(`https://embodied-astrology.netlify.app/.netlify/functions/api?action=LOGIN&token=${token}&stytch_token_type=${stytch_token_type}`)
      .then((res) => res.json().then(handleresponse));
    }
  </script>
</html>